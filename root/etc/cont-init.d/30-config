#!/usr/bin/with-contenv bash

# Crearea directoriilor necesare
mkdir -p /openvpn/pid /openvpn/sock /openvpn/tmp /dev/net /config/log /config/etc/tmp

# Crearea dispozitivului tun dacă nu există
if [ ! -c /dev/net/tun ]; then
  mknod /dev/net/tun c 10 200
fi

echo "Please login with the originally generated password."
echo "Please make sure to change it. If you have already changed it, please disregard."

# Verificarea existenței fișierului PID și oprirea procesului OpenVPN
if [ -f /var/run/openvpnas.pid ]; then
    kill $(cat /var/run/openvpnas.pid)
fi

# Instalare sau actualizare openvpn-as
if [ -f /version.txt ]; then
    OPENVPNAS_VERSION=$(cat /version.txt)
    rm -rf /usr/local/openvpn_as
    ln -s /config /usr/local/openvpn_as
    if [ ! -f /config/etc/as.conf ]; then
        echo "Installing openvpn-as for the first time"
        apt-get update && \
        apt-get install -y \
            openvpn-as=$OPENVPNAS_VERSION
    else
        echo "Existing data found, reinstalling openvpn-as"
        apt-get update && \
        apt-get install -y \
            openvpn-as=$OPENVPNAS_VERSION
    fi
fi

# Copierea conținutului din /usr/local/openvpn_as în /config
cp -R /usr/local/openvpn_as/* /config

# Ștergerea fișierelor vechi de tip sock și pid
rm -rf /openvpn/sock/* /openvpn/pid/*

# Stabilirea permisiunilor adecvate pe directoarele configurate
chown -R abc:abc /config/log /config/etc/tmp
chmod -R 755 /openvpn
